# 前端性能优化

[参考拉钩教育总结](https://www.yuque.com/books/share/bee30889-85b8-442e-be5c-6c683f783e2f/sz3d6g)



## 请求和响应优化

目的：更快的内容到达时间



### DNS 解析优化

- 减少DNS的请求次数
- 进行DNS预获取：DNS Prefetch

为了减少DNS查找和允许高度并行下载，原则将资源划分为至少两个但不超过四个域名



#### dns-prefetch

DNS-prefetch是尝试在请求资源之前解析域名，这适用于页面首次加载完成后要加载的文件或用户尝试打开的链接目标（针对网页中的跨域资源请求）。可以帮助开发人员 **掩盖** DNS解析延迟。

通过HTML文档标签标识：

```html
<link ref="dns-prefetch" href="https://fonts.googleapis.com" />
```

通过HTTP Link 请求头标识：

```xml
Link: <https://fonts.gstatic.com/ >; ref=dns-prefetch
```

注意事项：

1. `dns-prefetch` 仅对跨域域上的DNS查找有效。因为当前域在首次访问时已经完成了DNS解析。
2. `dns-prefetch` 需慎用，**多页面** 重复DNS预解析会增加重复DNS查询。
3. 默认情况下浏览器的隐式`dns-prefetch`会对页面中和当前域下，不在同一个域的域名进行预获取。
4. 虽然DNS Prefetch 能加快页面的解析速度，但是也容易导致DNS查询次数的浪费。

```html
// 禁用DSN预查询
<meta http-equiv="x-dns-prefetch-control" content="off" />
```



#### 其它DNS解析优化

1. 延长DNS缓存时间
2. 尽可能使用A或AAAA记录代替CNAME
3. 使用CDN加速域名
4. 自己搭建DNS服务



### HTTP 长连接

#### 长连接

HTTP1.1引入默认长连接方式，可以被多个请求复用。（不用显式声明Connection：keep-alive）

客户端和服务器发现对方一段时间没有活动，就可以主动关闭连接。

显式关闭连接，客户端请求头标识：

```xml
Connection: close
```



#### 管道机制

HTTP1.1引入，在同一个TCP连接里，客户端可以同时发送多个请求。



#### Content-Length 字段

一个TCP连接可以发送多个回应，利用`Content-Length`字段，告诉浏览器本次回应的数据长度：

```xml
Content-Length：3495
```



#### 分块传输编码

使用 `Content-Length` 字段时，服务器必须知道回应的数据长度。

因此如果一些耗时的动态操作，服务器要等到所有操作完成才能发送数据，效率不高。

因此更好的处理，是产生一块数据，就发送一块。

采用`流模式（stream）`取代`缓存模式（buffer)`，HTTP1.1规定使用`Transfer-Encoding`字段代替`Content-Length`。

```xml
Transfer-Encoding: chunked
```



#### 长连接缺点

由于同一个TCP持久连接里，所有通讯是 **按序** 串行进行的，容易造成 **队头堵塞**。

优化：

1. 减少请求数（资源合并等）
2. 同时多开持久连接（域名分片）



### HTTP2

基于谷歌自研 `SPDY` 协议



#### 二进制协议

HTTP1.1版的头信息是文本（ASCII编码），数据体可以是文本也可以是二进制。

HTTP2则是一个彻底的二进制协议，头和数据体都是二进制，并称为：**头信息帧** 和 **数据帧**。



#### 多工

多工：双向的、实时的通信

HTTP2复用TCP连接。**在一个连接里，客户端和浏览器都可以同时发送多个请求和回应，并且不用按照顺序一一对应**。这样就避免了 **队头堵塞** 。



#### 数据流

HTTP2的数据包是不按顺序发送的，同个连接里连续的数据包，可能属于不同的回应。因此其对数据包做了标记。

HTTP2将每个请求或回应的 **所有数据包**，称为一个**数据流**。每个数据流都有一个独一无二的编号。

规定：客户端发出的数据流，ID一律为奇数，服务器发出的ID为偶数。

同时数据流发送过程中，客户端和服务端都可以发送信号（RES_STREAM帧），取消这个数据流而不需关闭TCP连接。

客户端还可以指定数据流的优先级。优先级越高，服务器越早回应。



#### 头信息压缩

HTTP协议不带有状态，每次请求都必须附上所有信息。因此很多字段是重复的，比如Cookie和User Agent。

HTTP2引入头信息压缩机制

1. 头信息使用 `gzip` 或 `compress` 压缩后再发送。
2. 客户端和服务端同时维护一张头信息表，所有字段都存入这个表，生成一个索引号，这样以后出现重复的字段，只发送索引号就可以提高速度了。



#### 服务器推送

HTTP2允许服务器未经请求，主动向客户端发送资源。



#### 参考链接

- https://developers.google.com/web/fundamentals/performance/http2?hl=zh-cn



### 避免重定向

#### 永久重定向

这种重定向被认为是永久性的，搜索引擎机器人会遇到该状态码时触发更新操作。

| 编码 | 含义               | 处理方法                                         | 典型应用场景              |
| ---- | ------------------ | ------------------------------------------------ | ------------------------- |
| 301  | Moved Permanently  | GET方法不会发生变更，其它方法有可能变更为GET方法 | 网站重构                  |
| 308  | Permanent Redirect | 方法和消息主体都不发生变化。                     | 网站重构，用于非GET方法。 |



#### 临时重定向

搜索引擎不会记录该更新、临时的连接。

| 编码 | 含义               | 处理方法                                                     | 典型应用场景                                                 |
| ---- | ------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 302  | Found              | GET方法不会发生变更，其它方法有可能会变更为GET               | 由于不可预见的原因，该页面暂时不可用。                       |
| 303  | See Other          | GET方法不会发生变更，其它方法会变更为GET方法（消息主体会丢失） | 用于PUT或POST请求完成之后进行页面转跳来防止由于页面刷新导致的操作的重复触发。 |
| 307  | Temporary Redirect | 方法和消息主体都不发生变化                                   | 由于不可预见的原因，该页面暂时不可用。当站点支持非GET方法的请求时，该状态码优于302状态均码。 |



#### 特殊重定向

两种特殊的重定向

| 编码 | 含义            | 典型应用场景                                                 |
| ---- | --------------- | ------------------------------------------------------------ |
| 300  | Multiple Choice | 不常用：所有选项在消息主体的HTML中列出。                     |
| 304  | Not Modified    | 发送用于重新验证的条件请求。表示缓存的响应仍然是新鲜的并且可以使用。 |



### 压缩传输的数据资源



#### HTTP响应数据压缩

##### 压缩JS、CSS



##### 使用Gzip压缩

浏览器和服务器之间会使用 **主动协商机制**。

浏览器通过发送 `Accept-Encoding：gzip，deflate，...` 首部，告诉服务器它所支持的压缩算法及各自优先级。

服务器则按优先级和自身支持从中选择一种，对响应的消息主体进行压缩，并且发送`Content-Encoding`首部来告诉浏览器使用的哪一种算法。

请求报文：

```xml
GET /baidu HTTP/1.1
Host：www.baidu.com
Accept-Encoding：gzip，deflate
```

响应报文：

```xml
HTTP/1.1 200 OK
...
Content-Encoding：gizp
...
```



##### 压缩图片



#### HTTP请求数据压缩

##### 头部数据压缩





