4.3 垃圾收集
---


> 前言

- JavaScript具有自动垃圾收集机制，即执行环境会管理代码执行过程中的使用内存。
- 垃圾收集器会按照固定的时间间隔（或代码执行中预定的收集时间），不同浏览器实现其时间间隔不同，*周期性*地执行垃圾回收，内存释放。
- 垃圾收集器会跟踪变量并对不再有用的变量打上标记，以备将来收回其占用的内存。
- 用于标记无用变量的策略可能会浏览器因实现而异，通常有两种策略，*标记清除*和*引用计数*。

> 标记清除

- JavaScript中最常用的垃圾收集方式。
- 垃圾收集器在运行的时候会给存储在内存中的所有变量都加上标记。
- 可以用任何方式来标记变量。如：通过翻转某个特殊的位来记录一个变量何时进入环境。或者使用一个“进入环境”的变量表及“离开环境”的变量表来跟踪哪个变量发生了变化。

> 引用计数

- 跟综并记录每个值被引用的次数，当这个值的引用次数变为0时，则说明没有办法再访问这个值了，因而被自动回收。
- 循环引用：对象A中包含一个指向对象B的指针，而对象B中也包含一个指向对象A的指针。
- Netscape Navigator3.0是最早使用引用计数策略的浏览器，因为循环引用等问题，其在Netscape在Navigator4.0中放弃了引用计数的方式，转用标记清除来实现垃圾收集。
- IE9以前中其BOM和DOM中的对象是使用C++以COM（组件对象模型）对象的形式来实现的，而COM对象的垃圾收集机制采用的就是引用计数。
- IE9把BOM和DOM对象都转换成了真正的JavaScript对象。
- 可以通过将变量设置为`null`来手动切断变量与它之前引用的值之间的连接，从而让垃圾收集器回收内存。

> 性能问题

- 垃圾收集器是周期性运行的。
- IE7（不包含）以下的垃圾收集器是根据内存的分配量运行的，即256个变量、4096个对象（或数组）字面量或者64KB字符串。
- IE7出发垃圾收集的变量分配、对象（数组）字面量元素的临界值被调整为动态修正。
- 在某些浏览器可以主动触发垃圾收集过程。

> 管理内存。

- 面临的问题：处于*安全性*的考虑，分配给Web浏览器的可用内存数量通常要比分配给桌面应用的程序少，内存限制问题会影响给变量分配内存和调用栈以及在一个线程中能够同时执行的语句数量。
- 优化内存的最佳方法[解除引用]：为执行中的代码只保存必要的数据，一旦数据不再用，最好通过将其值设置为`null`来释放其引用。*适用于大多全局对象和全局对象的属性*。
- 解除引用不意味着自动回收该值所占用的内存，而是让值脱离执行环境，以便垃圾收集器下次运行时将其回收。